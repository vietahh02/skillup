<mat-card class="mb-25 tagus-card">
    <mat-card-header>
        <h5 class="mb-0">User List</h5>
        <div class="box-button">
            <button mat-flat-button (click)="openCreateEmployeeDialog('300ms', '100ms')">Add New</button>
            <button mat-stroked-button color="primary" (click)="downloadTemplate()" [disabled]="isDownloading">
                <mat-icon *ngIf="!isDownloading">download</mat-icon>
                <mat-icon *ngIf="isDownloading">hourglass_empty</mat-icon>
                {{ isDownloading ? 'Downloading...' : 'Download Template' }}
            </button>
            <input 
                type="file" 
                #fileInput 
                accept=".xlsx,.xls" 
                (change)="onFileSelected($event)" 
                style="display: none;"
            >
            <button mat-stroked-button color="accent" (click)="triggerFileInput()" [disabled]="isImporting">
                <mat-icon *ngIf="!isImporting">upload_file</mat-icon>
                <mat-icon *ngIf="isImporting">hourglass_empty</mat-icon>
                {{ isImporting ? 'Importing...' : 'Import Excel' }}
            </button>
        </div>
    </mat-card-header>
    <div class="tagus-search-box mb-15">
        <input type="text" class="input-search border-radius" placeholder="Search here" [(ngModel)]="searchTerm" (input)="search()">
        <button  mat-flat-button class="tagus" (click)="search()"><i class="ri-search-line"></i></button>
    </div>
    <mat-card-content>
        <div class="teamMembersListTable tagus-mat-table mat-elevation-z8">

            <div *ngIf="isLoading" class="loading-container">
                <div class="loading-text">Loading...</div>
            </div>

            <table mat-table [dataSource]="dataSource" class="overflow-x-hidden" [class.loading]="isLoading">

                <!-- User Column -->
                <ng-container matColumnDef="user">
                    <th mat-header-cell *matHeaderCellDef class="text-start">User</th>
                    <td mat-cell *matCellDef="let element" class="text-start">
                        <div class="d-flex align-items-center user-info">
                            <img [src]="element.avatarUrl || 'img/user/user1.jpg'" class="rounded-circle" width="45" alt="user">
                            <div class="title">
                                <span [matTooltip]="maxLengthText(element.name) ? element.name : ''">{{formatText(element.name)}}</span>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Task Progress Column -->
                <ng-container matColumnDef="progress">
                    <th mat-header-cell *matHeaderCellDef>All Course Progress</th>
                    <td mat-cell *matCellDef="let element" class="text-start">
                        <span class="d-block gray-color mb-5 fw-normal">{{element.allCourseProgress || 0}}%</span>
                        <mat-progress-bar mode="determinate" value="{{element.allCourseProgress || 0}}"></mat-progress-bar>
                    </td>
                </ng-container>

                <!-- Email Column -->
                <ng-container matColumnDef="email">
                    <th mat-header-cell *matHeaderCellDef>Email</th>
                    <td mat-cell *matCellDef="let element"><a href="mailto:{{element.email}}" [matTooltip]="maxLengthText(element.email) ? element.email : ''">{{formatText(element.email)}}</a></td>
                </ng-container>

                <!-- Level Column -->
                <ng-container matColumnDef="level">
                    <th mat-header-cell *matHeaderCellDef>Level</th>
                    <td mat-cell *matCellDef="let element">{{element.level}}</td>
                </ng-container>

                <!-- Courses Column -->
                <ng-container matColumnDef="courses">
                    <th mat-header-cell *matHeaderCellDef>Courses</th>
                    <td mat-cell *matCellDef="let element">{{element.totalCourseEnroll || 0}}</td>
                </ng-container>

                <ng-container matColumnDef="role">
                    <th mat-header-cell *matHeaderCellDef>Role</th>
                    <td mat-cell *matCellDef="let element">
                        <span
                        class="role-badge"
                        [ngClass]="{
                            'employee': element.role === 'Employee',
                            'lecturer': element.role === 'Lecturer',
                            'admin': element.role === 'Admin',
                            'manager': element.role === 'Manager'
                        }"
                        >
                        {{ element.role }}
                        </span>
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let element">
                        <span class="badge" [ngClass]="element.status ? 'text-soft-success' : 'text-soft-danger'">{{element.status ? 'Active' : 'Inactive'}}</span>
                    </td>
                </ng-container>

                <!-- Action Column -->
                <ng-container matColumnDef="action">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let element" class="cell-action">
                        <button mat-icon-button (click)="goDetail(element)">
                            <mat-icon>visibility</mat-icon>
                        </button>
                        <mat-card-content>
                            <button mat-icon-button [matMenuTriggerFor]="menu">
                                <mat-icon>edit</mat-icon>
                            </button>
                            <mat-menu #menu="matMenu">
                                <button *ngFor="let level of levelOptions" disabled="{{element.levelId === level.levelId}}" mat-menu-item (click)="changeLevel(element, level)">
                                    <span >{{level.name}}</span>
                                </button>
                            </mat-menu>
                        </mat-card-content>
                        <mat-card-content>
                            <button mat-icon-button [matMenuTriggerFor]="menu1">
                                <mat-icon>lock</mat-icon>
                            </button>
                            <mat-menu #menu1="matMenu">
                                <button mat-menu-item (click)="banUser(element, false)" [disabled]="!element.status">
                                    <span>Ban</span>
                                </button>
                                <button mat-menu-item (click)="banUser(element, true)" [disabled]="element.status">
                                    <span>UnBan </span>
                                </button>
                            </mat-menu>
                        </mat-card-content>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
            <mat-paginator [pageSizeOptions]="[5, 10, 20, 50]" showFirstLastButtons [pageSize]="pageSize"
                [pageIndex]="currentPage - 1" (page)="onPaginatorChange($event)" [disabled]="false"
                [length]="totalItems"></mat-paginator>
        </div>
    </mat-card-content>
</mat-card>