<!-- User Report Table -->
<mat-card class="mb-25 tagus-card">
    <mat-card-header>
        <h5 class="mb-0">User Report Details</h5>
        <div class="box-button d-flex align-items-center gap-2">
            <mat-form-field appearance="outline" class="filter-field mb-0" style="min-width: 150px;">
                <mat-label>From Date</mat-label>
                <input matInput [matDatepicker]="pickerFrom" [(ngModel)]="dateFrom" (dateChange)="onDateFilterChange()" placeholder="Start date">
                <mat-datepicker-toggle matIconSuffix [for]="pickerFrom"></mat-datepicker-toggle>
                <mat-datepicker #pickerFrom (closed)="onDateFilterChange()"></mat-datepicker>
                <mat-error *ngIf="isDateRangeInvalid">From Date must be before or equal to To Date</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="filter-field mb-0" style="min-width: 150px;">
                <mat-label>To Date</mat-label>
                <input matInput [matDatepicker]="pickerTo" [(ngModel)]="dateTo" (dateChange)="onDateFilterChange()" placeholder="End date">
                <mat-datepicker-toggle matIconSuffix [for]="pickerTo"></mat-datepicker-toggle>
                <mat-datepicker #pickerTo (closed)="onDateFilterChange()"></mat-datepicker>
                <mat-error *ngIf="isDateRangeInvalid">To Date must be after or equal to From Date</mat-error>
            </mat-form-field>
            <button mat-icon-button (click)="clearDateFilters()" matTooltip="Clear date filters" *ngIf="dateFrom || dateTo">
                <mat-icon>close</mat-icon>
            </button>
            <button mat-stroked-button color="primary" (click)="exportToExcel()">
                <mat-icon>download</mat-icon>
                Export Report
            </button>
        </div>
    </mat-card-header>
    <div class="tagus-search-box mb-15">
        <input type="text" class="input-search border-radius" placeholder="Search by name, email..." [(ngModel)]="searchTerm" (keyup.enter)="search()">
        <button mat-flat-button class="tagus" (click)="search()">
            <i class="ri-search-line"></i>
        </button>
    </div>
    <mat-card-content>
        <div class="teamMembersListTable tagus-mat-table mat-elevation-z8">
            <div *ngIf="isLoading" class="loading-container">
                <div class="loading-text">Loading...</div>
            </div>

            <table mat-table [dataSource]="dataSource" class="overflow-x-hidden" [class.loading]="isLoading">

                <!-- User Column -->
                <ng-container matColumnDef="user">
                    <th mat-header-cell *matHeaderCellDef class="text-start">User</th>
                    <td mat-cell *matCellDef="let element" class="text-start">
                        <div class="d-flex align-items-center user-info">
                            <img [src]="element.avatarUrl || 'img/user/user1.jpg'" class="rounded-circle img-user" alt="user">
                            <div class="title ms-12">
                                <span [matTooltip]="maxLengthText(element.fullName) ? element.fullName : ''">{{ formatText(element.fullName) }}</span>
                                <span class="d-block gray-color fw-normal" style="font-size: 12px;" [matTooltip]="maxLengthText(element.email) ? element.email : ''">{{ formatText(element.email) }}</span>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Level Column -->
                <ng-container matColumnDef="level">
                    <th mat-header-cell *matHeaderCellDef>Level</th>
                    <td mat-cell *matCellDef="let element">{{ element.level }}</td>
                </ng-container>

                <!-- Courses Column -->
                <ng-container matColumnDef="courses">
                    <th mat-header-cell *matHeaderCellDef>Courses</th>
                    <td mat-cell *matCellDef="let element">
                        <span class="d-block fw-semibold">{{ element.course.total }}</span>
                        <span class="d-block gray-color" style="font-size: 12px;">
                            {{ element.course.completed }} completed, {{ element.course.inProgress }} in progress, {{ element.course.failed }} failed
                        </span>
                    </td>
                </ng-container>

                <!-- Progress Column -->
                <ng-container matColumnDef="progress">
                    <th mat-header-cell *matHeaderCellDef>Avg Progress</th>
                    <td mat-cell *matCellDef="let element" class="text-start">
                        <span class="d-block gray-color mb-5 fw-normal">{{ element.avgProgress || 0 }}%</span>
                        <mat-progress-bar mode="determinate" [value]="element.avgProgress || 0"></mat-progress-bar>
                    </td>
                </ng-container>

                <!-- Completion Rate Column -->
                <ng-container matColumnDef="completionRate">
                    <th mat-header-cell *matHeaderCellDef>Completion Rate</th>
                    <td mat-cell *matCellDef="let element">
                        <span class="fw-semibold" [ngClass]="{
                            'text-success': element.completionRate >= 80,
                            'text-warning': element.completionRate >= 50 && element.completionRate < 80,
                            'text-danger': element.completionRate < 50
                        }">
                            {{ element.completionRate || 0 }}%
                        </span>
                    </td>
                </ng-container>

                <!-- Learning Time Column -->
                <ng-container matColumnDef="learningTime">
                    <th mat-header-cell *matHeaderCellDef>Learning Time</th>
                    <td mat-cell *matCellDef="let element">{{ formatDuration(element.learningTime) }}</td>
                </ng-container>

                <!-- Quiz Score Column -->
                <ng-container matColumnDef="quizScore">
                    <th mat-header-cell *matHeaderCellDef>Quiz Score</th>
                    <td mat-cell *matCellDef="let element">
                        <span class="fw-semibold" [ngClass]="{
                            'text-success': element.quizScore >= 90,
                            'text-warning': element.quizScore >= 70 && element.quizScore < 90,
                            'text-danger': element.quizScore < 70
                        }">
                            {{ element.quizScore || 0 }}%
                        </span>
                    </td>
                </ng-container>

                <!-- Last Active Column -->
                <ng-container matColumnDef="lastActive">
                    <th mat-header-cell *matHeaderCellDef>Last Active</th>
                    <td mat-cell *matCellDef="let element">{{ formatDate(element.lastActivity) }}</td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let element">
                        <span class="badge" [ngClass]="element.status ? 'text-soft-success' : 'text-soft-danger'">
                            {{ element.status ? 'Active' : 'Inactive' }}
                        </span>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
            <mat-paginator 
                [pageSizeOptions]="[5, 10, 20, 50]" 
                showFirstLastButtons 
                [pageSize]="pageSize"
                [pageIndex]="currentPage - 1" 
                (page)="onPaginatorChange($event)" 
                [length]="totalItems">
            </mat-paginator>
        </div>
    </mat-card-content>
</mat-card>
