<!-- User Feedback Section -->
<mat-card class="mb-25 tagus-card">
    <mat-card-content>
        <div class="p-md-25 feedback-section">
            <div class="d-flex justify-content-between align-items-center feedback-header">
                <h5 class="mb-0">Student Feedback ({{totalFeedbacks || 0}} reviews)</h5>
            </div>

            <!-- Feedback List -->
            <div class="feedback-list">
                <!-- Feedback Item 1 -->
                <div class="feedback-item" *ngFor="let feedback of feedbacks">
                    <div class="d-flex align-items-start">
                        <img [src]="feedback.userAvatarUrl || 'img/user/user1.jpg'" class="rounded-circle me-15 avatar-feedback" alt="user">
                        <div class="flex-grow-1">
                            <div class="feedback-header">
                                <div class="user-info">
                                    <h6>{{feedback.userName || ''}}</h6>
                                    <span class="timestamp">{{getTimeAgo(feedback.createdAt) || ''}}</span>
                                </div>
                            </div>
                            <p class="feedback-content">
                                {{feedback.content || ''}}
                            </p>
                            
                            <!-- Reply and Delete buttons -->
                            <div class="mb-15 d-flex align-items-center">
                                <button mat-button class="reply-btn me-15" (click)="toggleReply(feedback.feedbackId.toString())">
                                    <i class="ri-reply-line me-5"></i> Reply
                                </button>
                                <button mat-button class="delete-feedback-btn" *ngIf="canDelete(feedback.userId)" (click)="deleteFeedback(feedback.feedbackId)">
                                    <i class="ri-delete-bin-line me-5"></i> Delete
                                </button>
                            </div>

                            <!-- Reply input (hidden by default) -->
                            <div class="reply-input" id="reply-{{feedback.feedbackId}}" style="display: none;">
                                <div class="d-flex align-items-start">
                                    <img [src]="currentUser?.avatarUrl || 'img/user/user1.jpg'" class="rounded-circle me-10 avatar-feedback" alt="user">
                                    <div class="flex-grow-1">
                                        <textarea 
                                            class="reply-textarea" 
                                            id="reply-content-{{feedback.feedbackId}}" 
                                            [(ngModel)]="commentContents[feedback.feedbackId]"
                                            [maxlength]="maxCommentLength"
                                            rows="3" 
                                            placeholder="Write a thoughtful reply...">
                                        </textarea>
                                        <div class="reply-char-count" [class.error]="getCommentLength(feedback.feedbackId) > maxCommentLength">
                                            <span *ngIf="getCommentLength(feedback.feedbackId) > maxCommentLength" class="text-danger">
                                                Reply cannot exceed {{ maxCommentLength }} characters
                                            </span>
                                            <span *ngIf="getCommentLength(feedback.feedbackId) <= maxCommentLength">
                                                {{ getCommentLength(feedback.feedbackId) }} / {{ maxCommentLength }} characters
                                            </span>
                                        </div>
                                        <div class="reply-actions">
                                            <button 
                                                mat-flat-button 
                                                class="tagus me-10" 
                                                (click)="createComment(feedback)"
                                                [disabled]="!isCommentValid(feedback.feedbackId)">
                                                Post Reply
                                            </button>
                                            <button mat-button (click)="toggleReply(feedback.feedbackId.toString())">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Comments for this feedback -->
                            <div class="comments-section">
                                <!-- Comment 1 -->
                                <div class="comment-item d-flex align-items-start" *ngFor="let comment of feedback.comments">
                                    <img [src]="comment.userAvatarUrl || 'img/user/user1.jpg'" class="rounded-circle me-10" width="35" alt="user">
                                    <div class="flex-grow-1">
                                        <div class="comment-content">
                                            <div class="comment-header d-flex justify-content-between align-items-center">
                                                <div class="comment-info">
                                                    <span class="comment-user">{{comment.userName || ''}}</span>
                                                    <span class="comment-time ms-15">{{getTimeAgo(comment.createdAt) || ''}}</span>
                                                </div>
                                                <button mat-icon-button class="delete-comment-btn" *ngIf="canDelete(comment.userId) && status !== 'Rejected'" (click)="deleteComment(comment.commentId, feedback.feedbackId)" title="Delete comment">
                                                    <mat-icon class="small-icon">delete</mat-icon>
                                                </button>
                                            </div>
                                            <p class="comment-text">{{comment.commentText || ''}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Load More Button -->
            <div class="load-more-reviews" *ngIf="totalFeedbacks > feedbacks.length">
                <button mat-flat-button class="gray" (click)="loadMoreFeedbacks()">Load More Reviews</button>
            </div>
        </div>
    </mat-card-content>
</mat-card>